<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Acceso - PDF Signer USIV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .url-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        .url-test input {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .url-test button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .url-test button:hover {
            background: #2980b9;
        }
        .status {
            margin-left: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #2ecc71;
            color: white;
        }
        .status.error {
            background: #e74c3c;
            color: white;
        }
        .status.testing {
            background: #f39c12;
            color: white;
        }
        .response-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            font-family: monospace;
            font-size: 12px;
        }
        .api-test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #229954;
        }
        .btn.secondary {
            background: #95a5a6;
        }
        .btn.secondary:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <h1>üîç Verificaci√≥n de Acceso - PDF Signer USIV</h1>
    
    <!-- Pruebas de Conectividad -->
    <div class="container">
        <h2>1. üåê Pruebas de Conectividad</h2>
        
        <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
            <h4>üîí URLs HTTPS (Recomendadas - Evitan Firewall Corporativo)</h4>
            <p><strong>Si tienes SSL configurado, usa estas URLs:</strong></p>
            <ul>
                <li><strong>Aplicaci√≥n:</strong> <a href="https://validador.usiv.cl/pdf-signer/" target="_blank">https://validador.usiv.cl/pdf-signer/</a></li>
                <li><strong>Health Check:</strong> <a href="https://validador.usiv.cl/pdf-signer/api/health" target="_blank">https://validador.usiv.cl/pdf-signer/api/health</a></li>
                <li><strong>Swagger UI:</strong> <a href="https://validador.usiv.cl/pdf-signer/swagger-ui/index.html" target="_blank">https://validador.usiv.cl/pdf-signer/swagger-ui/index.html</a></li>
            </ul>
            <p><em>üí° HTTPS suele bypasear firewalls corporativos que bloquean HTTP</em></p>
        </div>
        
        <div class="url-test">
            <input type="text" id="nginx-https-url" value="https://validador.usiv.cl/pdf-signer/" readonly>
            <button onclick="testUrl('nginx-https-url', 'nginx-https-status')">üîí Probar Nginx HTTPS</button>
            <span id="nginx-https-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="nginx-url" value="http://validador.usiv.cl/pdf-signer/" readonly>
            <button onclick="testUrl('nginx-url', 'nginx-status')">Probar Nginx HTTP</button>
            <span id="nginx-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="tomcat-url" value="http://validador.usiv.cl:8080/pdf-signer/" readonly>
            <button onclick="testUrl('tomcat-url', 'tomcat-status')">Probar Tomcat</button>
            <span id="tomcat-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="health-https-url" value="https://validador.usiv.cl/pdf-signer/api/health" readonly>
            <button onclick="testUrl('health-https-url', 'health-https-status')">üîí Health Check HTTPS</button>
            <span id="health-https-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="health-url" value="http://validador.usiv.cl/pdf-signer/api/health" readonly>
            <button onclick="testUrl('health-url', 'health-status')">Health Check HTTP</button>
            <span id="health-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="swagger-https-url" value="https://validador.usiv.cl/pdf-signer/swagger-ui/index.html" readonly>
            <button onclick="testUrl('swagger-https-url', 'swagger-https-status')">üîí Swagger UI HTTPS</button>
            <span id="swagger-https-status" class="status">No probado</span>
        </div>
        
        <div class="url-test">
            <input type="text" id="swagger-url" value="http://validador.usiv.cl/pdf-signer/swagger-ui/index.html" readonly>
            <button onclick="testUrl('swagger-url', 'swagger-status')">Swagger UI HTTP</button>
            <span id="swagger-status" class="status">No probado</span>
        </div>
    </div>
    
    <!-- Pruebas de API -->
    <div class="container">
        <h2>2. Pruebas de API</h2>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107;">
            <h4>üí° Recomendaci√≥n: Usar HTTPS</h4>
            <p>Si configuraste SSL, cambia la URL base a HTTPS para evitar problemas de firewall corporativo.</p>
        </div>
        
        <div class="api-test">
            <h3>üîê Autenticaci√≥n</h3>
            <div class="form-group">
                <label>URL Base de API:</label>
                <select id="protocol-selector" onchange="updateApiBase()" style="margin-bottom: 5px; padding: 5px;">
                    <option value="https">üîí HTTPS (Recomendado)</option>
                    <option value="http" selected>üîì HTTP</option>
                </select>
                <input type="text" id="api-base" value="http://validador.usiv.cl/pdf-signer/api">
            </div>
            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="username" value="admin">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="password" value="admin123">
            </div>
            <button class="btn" onclick="testLogin()">Probar Login</button>
            <button class="btn secondary" onclick="testValidateToken()">Validar Token</button>
            <div id="auth-response" class="response-info" style="display:none;"></div>
        </div>
        
        <div class="api-test">
            <h3>üìÑ Subida de PDF (P√∫blico)</h3>
            <div class="form-group">
                <label>Archivo PDF:</label>
                <input type="file" id="pdf-file" accept=".pdf">
            </div>
            <div class="form-group">
                <label>T√≠tulo del documento:</label>
                <input type="text" id="doc-title" value="Documento de Prueba">
            </div>
            <button class="btn" onclick="testPdfUpload()">Subir PDF</button>
            <div id="upload-response" class="response-info" style="display:none;"></div>
        </div>
    </div>
    
    <!-- Informaci√≥n del Sistema -->
    <div class="container">
        <h2>3. Informaci√≥n del Sistema</h2>
        <div id="system-info">
            <p><strong>IP del Servidor:</strong> validador.usiv.cl</p>
            <p><strong>Puerto Nginx:</strong> 80</p>
            <p><strong>Puerto Tomcat:</strong> 8080</p>
            <p><strong>Contexto de Aplicaci√≥n:</strong> /pdf-signer/</p>
            <p><strong>Fecha de Verificaci√≥n:</strong> <span id="current-date"></span></p>
        </div>
        
        <button class="btn" onclick="runAllTests()">üöÄ Ejecutar Todas las Pruebas</button>
        <button class="btn secondary" onclick="clearResults()">üßπ Limpiar Resultados</button>
    </div>
    
    <!-- Soluci√≥n de Problemas -->
    <div class="container">
        <h2>4. üîß Soluci√≥n de Problemas</h2>
        
        <div class="api-test">
            <h3>‚ùå Error "NetworkError when attempting to fetch resource"</h3>
            <p><strong>Causa:</strong> Problemas de CORS o conectividad desde el navegador.</p>
            
            <h4>üõ†Ô∏è Soluciones Alternativas:</h4>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                <h5>1. Verificaci√≥n Manual en Navegador</h5>
                <p>Abre estas URLs directamente en nuevas pesta√±as:</p>
                <ul>
                    <li><a href="http://validador.usiv.cl/pdf-signer/" target="_blank">http://validador.usiv.cl/pdf-signer/</a></li>
                    <li><a href="http://validador.usiv.cl:8080/pdf-signer/" target="_blank">http://validador.usiv.cl:8080/pdf-signer/</a></li>
                    <li><a href="http://validador.usiv.cl/pdf-signer/api/health" target="_blank">http://validador.usiv.cl/pdf-signer/api/health</a></li>
                    <li><a href="http://validador.usiv.cl/pdf-signer/swagger-ui/index.html" target="_blank">http://validador.usiv.cl/pdf-signer/swagger-ui/index.html</a></li>
                </ul>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                <h5>2. Comandos desde Terminal/CMD</h5>
                <p>Ejecuta estos comandos en tu terminal para verificar conectividad:</p>
                
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Verificar conectividad b√°sica</strong><br>
                    ping validador.usiv.cl
                </div>
                
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Verificar puertos abiertos</strong><br>
                    telnet validador.usiv.cl 80<br>
                    telnet validador.usiv.cl 8080
                </div>
                
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Probar con curl (si est√° disponible)</strong><br>
                    curl -I http://validador.usiv.cl/pdf-signer/<br>
                    curl -I http://validador.usiv.cl:8080/pdf-signer/
                </div>
                
                <div style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Probar API de autenticaci√≥n</strong><br>
                    curl -X POST "http://validador.usiv.cl/pdf-signer/api/auth/login" \<br>
                    &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                    &nbsp;&nbsp;-d '{"username":"admin","password":"admin123"}'
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                <h5>3. Verificaci√≥n con PowerShell (Windows)</h5>
                <div style="background: #012456; color: #ffffff; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Verificar conectividad</strong><br>
                    Test-NetConnection -ComputerName validador.usiv.cl -Port 80<br>
                    Test-NetConnection -ComputerName validador.usiv.cl -Port 8080
                </div>
                
                <div style="background: #012456; color: #ffffff; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0;">
                    <strong># Probar con Invoke-WebRequest</strong><br>
                    Invoke-WebRequest -Uri "http://validador.usiv.cl/pdf-signer/api/health" -Method GET
                </div>
            </div>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107;">
                <h5>‚ö†Ô∏è Posibles Causas del Error</h5>
                <ul>
                    <li><strong>Firewall corporativo:</strong> Tu red puede estar bloqueando conexiones externas</li>
                    <li><strong>Proxy de red:</strong> Configuraci√≥n de proxy interfiriendo</li>
                    <li><strong>CORS no configurado:</strong> El servidor no permite peticiones desde el navegador</li>
                    <li><strong>Servidor inaccesible:</strong> El servicio puede estar ca√≠do temporalmente</li>
                    <li><strong>DNS/Routing:</strong> Problemas de enrutamiento de red</li>
                </ul>
            </div>
            
            <div style="background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #17a2b8;">
                <h5>‚úÖ Qu√© Hacer Si Todo Funciona</h5>
                <p>Si los comandos de terminal funcionan pero el navegador no:</p>
                <ul>
                    <li>El servidor est√° funcionando correctamente</li>
                    <li>El problema es de CORS en el navegador</li>
                    <li>Usa herramientas como Postman para probar la API</li>
                    <li>Accede directamente a las URLs en el navegador</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let authToken = null;
        
        // Mostrar fecha actual
        document.getElementById('current-date').textContent = new Date().toLocaleString('es-CL');
        
        // Funci√≥n para actualizar URL base seg√∫n protocolo
        function updateApiBase() {
            const protocol = document.getElementById('protocol-selector').value;
            const apiBaseInput = document.getElementById('api-base');
            const currentUrl = apiBaseInput.value;
            
            if (protocol === 'https') {
                apiBaseInput.value = currentUrl.replace('http://', 'https://');
            } else {
                apiBaseInput.value = currentUrl.replace('https://', 'http://');
            }
        }
        
        // Funci√≥n para probar URLs
        async function testUrl(inputId, statusId) {
            const url = document.getElementById(inputId).value;
            const statusElement = document.getElementById(statusId);
            
            statusElement.textContent = 'Probando...';
            statusElement.className = 'status testing';
            
            // Crear elemento de informaci√≥n de respuesta
            let responseInfo = document.getElementById(inputId + '-info');
            if (!responseInfo) {
                responseInfo = document.createElement('div');
                responseInfo.id = inputId + '-info';
                responseInfo.className = 'response-info';
                statusElement.parentNode.appendChild(responseInfo);
            }
            
            try {
                // Intentar con fetch normal primero
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    statusElement.textContent = 'Accesible ‚úÖ';
                    statusElement.className = 'status success';
                    responseInfo.style.display = 'block';
                    responseInfo.innerHTML = `
                        <strong>Estado:</strong> HTTP ${response.status} - Conexi√≥n exitosa<br>
                        <strong>URL:</strong> ${url}<br>
                        <strong>Content-Type:</strong> ${response.headers.get('content-type') || 'No especificado'}<br>
                        <strong>Hora:</strong> ${new Date().toLocaleTimeString('es-CL')}
                    `;
                } else {
                    statusElement.textContent = `HTTP ${response.status}`;
                    statusElement.className = 'status error';
                    responseInfo.style.display = 'block';
                    responseInfo.innerHTML = `
                        <strong>Estado:</strong> HTTP ${response.status} - ${response.statusText}<br>
                        <strong>URL:</strong> ${url}<br>
                        <strong>Hora:</strong> ${new Date().toLocaleTimeString('es-CL')}
                    `;
                }
                
            } catch (error) {
                // Si falla con CORS, intentar con no-cors
                try {
                    await fetch(url, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    
                    statusElement.textContent = 'Accesible (CORS limitado)';
                    statusElement.className = 'status success';
                    responseInfo.style.display = 'block';
                    responseInfo.innerHTML = `
                        <strong>Estado:</strong> Servidor responde (limitado por CORS)<br>
                        <strong>URL:</strong> ${url}<br>
                        <strong>Recomendaci√≥n:</strong> Abrir URL directamente en nueva pesta√±a<br>
                        <strong>Hora:</strong> ${new Date().toLocaleTimeString('es-CL')}<br>
                        <a href="${url}" target="_blank" style="color: #3498db;">üîó Abrir en nueva pesta√±a</a>
                    `;
                    
                } catch (corsError) {
                    statusElement.textContent = 'Error de conexi√≥n';
                    statusElement.className = 'status error';
                    responseInfo.style.display = 'block';
                    responseInfo.innerHTML = `
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>URL:</strong> ${url}<br>
                        <strong>Posibles causas:</strong><br>
                        ‚Ä¢ Servidor no accesible desde internet<br>
                        ‚Ä¢ Firewall bloqueando conexiones<br>
                        ‚Ä¢ Problemas de red<br>
                        <strong>Soluci√≥n:</strong> <a href="${url}" target="_blank" style="color: #3498db;">üîó Probar manualmente</a>
                    `;
                }
            }
        }
        
        // Funci√≥n para probar login
        async function testLogin() {
            const apiBase = document.getElementById('api-base').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const responseDiv = document.getElementById('auth-response');
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = 'Probando autenticaci√≥n...';
            
            try {
                const response = await fetch(`${apiBase}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.token;
                    responseDiv.innerHTML = `
                        <strong>‚úÖ Login Exitoso</strong><br>
                        <strong>Usuario:</strong> ${data.username}<br>
                        <strong>Rol:</strong> ${data.role}<br>
                        <strong>Token:</strong> ${data.token.substring(0, 50)}...<br>
                        <strong>Tipo:</strong> ${data.tokenType}
                    `;
                } else {
                    responseDiv.innerHTML = `
                        <strong>‚ùå Error de Login</strong><br>
                        <strong>HTTP Status:</strong> ${response.status}<br>
                        <strong>Mensaje:</strong> ${data.message || 'Error desconocido'}
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = `
                    <strong>‚ùå Error de Conexi√≥n</strong><br>
                    <strong>Error:</strong> ${error.message}<br>
                    <strong>Tipo:</strong> ${error.name}<br>
                    <br>
                    <strong>üîß Posibles soluciones:</strong><br>
                    ‚Ä¢ Verificar que el servidor est√© ejecut√°ndose<br>
                    ‚Ä¢ Comprobar configuraci√≥n CORS en el servidor<br>
                    ‚Ä¢ Probar con herramientas como Postman o curl<br>
                    <br>
                    <strong>üß™ Comando curl para probar:</strong><br>
                    <code style="background: #f0f0f0; padding: 5px; display: block; margin: 5px 0;">
                    curl -X POST "${apiBase}/auth/login" \<br>
                    &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                    &nbsp;&nbsp;-d '{"username":"${username}","password":"${password}"}'
                    </code>
                `;
            }
        }
        
        // Funci√≥n para validar token
        async function testValidateToken() {
            if (!authToken) {
                alert('Primero debes hacer login para obtener un token');
                return;
            }
            
            const apiBase = document.getElementById('api-base').value;
            const responseDiv = document.getElementById('auth-response');
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = 'Validando token...';
            
            try {
                const response = await fetch(`${apiBase}/auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.innerHTML = `
                        <strong>‚úÖ Token V√°lido</strong><br>
                        <strong>Usuario:</strong> ${data.username}<br>
                        <strong>Rol:</strong> ${data.role}<br>
                        <strong>Expira:</strong> ${new Date(data.exp * 1000).toLocaleString('es-CL')}
                    `;
                } else {
                    responseDiv.innerHTML = `
                        <strong>‚ùå Token Inv√°lido</strong><br>
                        <strong>Mensaje:</strong> ${data.message || 'Token expirado o inv√°lido'}
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = `
                    <strong>‚ùå Error de Validaci√≥n</strong><br>
                    <strong>Error:</strong> ${error.message}
                `;
            }
        }
        
        // Funci√≥n para probar subida de PDF
        async function testPdfUpload() {
            const apiBase = document.getElementById('api-base').value;
            const fileInput = document.getElementById('pdf-file');
            const title = document.getElementById('doc-title').value;
            const responseDiv = document.getElementById('upload-response');
            
            if (!fileInput.files[0]) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = 'Subiendo archivo...';
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('title', title);
            
            try {
                const response = await fetch(`${apiBase}/pdf/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    responseDiv.innerHTML = `
                        <strong>‚úÖ Subida Exitosa</strong><br>
                        <strong>Archivo:</strong> ${data.filename}<br>
                        <strong>Tama√±o:</strong> ${data.size} bytes<br>
                        <strong>URL de Descarga:</strong> <a href="${data.downloadUrl}" target="_blank">${data.downloadUrl}</a><br>
                        <strong>Token de Descarga:</strong> ${data.downloadToken}
                    `;
                } else {
                    responseDiv.innerHTML = `
                        <strong>‚ùå Error de Subida</strong><br>
                        <strong>Mensaje:</strong> ${data.message || 'Error desconocido'}
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = `
                    <strong>‚ùå Error de Conexi√≥n</strong><br>
                    <strong>Error:</strong> ${error.message}
                `;
            }
        }
        
        // Funci√≥n para ejecutar todas las pruebas
        async function runAllTests() {
            console.log('Ejecutando todas las pruebas...');
            
            // Pruebas de conectividad
            await testUrl('nginx-url', 'nginx-status');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUrl('tomcat-url', 'tomcat-status');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUrl('health-url', 'health-status');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUrl('swagger-url', 'swagger-status');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Prueba de autenticaci√≥n
            await testLogin();
            
            alert('Todas las pruebas completadas. Revisa los resultados.');
        }
        
        // Funci√≥n para limpiar resultados
        function clearResults() {
            const statusElements = document.querySelectorAll('.status');
            statusElements.forEach(element => {
                element.textContent = 'No probado';
                element.className = 'status';
            });
            
            const responseElements = document.querySelectorAll('.response-info');
            responseElements.forEach(element => {
                element.style.display = 'none';
            });
            
            authToken = null;
        }
    </script>
</body>
</html>